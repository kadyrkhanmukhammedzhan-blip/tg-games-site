<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GameMaster Mini Games</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg:#0b1220; --card:#121a2b; --card2:#0f1728;
      --text:#e7eefc; --muted:#9fb2d6; --acc:#6aa9ff; --bad:#ff6a8a; --ok:#4cffb4;
      --border: rgba(255,255,255,.10);
    }
    *{box-sizing:border-box}
    body{
      margin:0; color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1200px 700px at 15% 0%, #182a55 0%, var(--bg) 55%);
    }
    a{color:inherit; text-decoration:none}
    .wrap{max-width:980px; margin:0 auto; padding:18px 14px 70px}
    .top{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:14px 16px; border:1px solid var(--border); border-radius:18px;
      background: rgba(18,26,43,.75); backdrop-filter: blur(8px);
    }
    .brand{display:flex; align-items:center; gap:10px; font-weight:800}
    .brand .dot{width:10px; height:10px; border-radius:50%; background:var(--acc); box-shadow:0 0 24px rgba(106,169,255,.7)}
    .pill{font-size:12px; color:var(--muted); border:1px solid var(--border); padding:6px 10px; border-radius:999px}
    .grid{display:grid; grid-template-columns: 1fr; gap:12px; margin-top:12px}
    .card{ padding:16px; border-radius:18px; border:1px solid var(--border); background: rgba(18,26,43,.75); }
    .card2{ padding:16px; border-radius:18px; border:1px solid var(--border); background: rgba(15,23,40,.75); }
    h1{margin:6px 0 10px; font-size:30px; line-height:1.1}
    h2{margin:0 0 10px; font-size:18px}
    p{margin:0 0 10px; color:var(--muted)}
    .row{display:flex; flex-wrap:wrap; gap:10px; align-items:center}
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:10px;
      padding:10px 14px; border-radius:12px; cursor:pointer; user-select:none;
      border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(106,169,255,.18), rgba(106,169,255,.06));
      color:var(--text);
    }
    .btn.secondary{ background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04)); }
    .btn.danger{ background: linear-gradient(180deg, rgba(255,106,138,.18), rgba(255,106,138,.06)); }
    .btn:active{transform: translateY(1px)}
    .btn:disabled{opacity:.55; cursor:not-allowed}
    .sep{height:1px; background:rgba(255,255,255,.08); margin:12px 0}
    input{
      width:100%;
      padding:10px 12px; border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(9,14,24,.45); color:var(--text);
      outline:none;
    }
    .muted{color:var(--muted)}
    .small{font-size:12px; color:var(--muted)}
    .chips{display:flex; gap:8px; flex-wrap:wrap}
    .chip{
      padding:7px 10px; border-radius:999px; border:1px solid var(--border);
      background: rgba(255,255,255,.04); color:var(--muted); cursor:pointer;
      user-select:none;
    }
    .chip.active{border-color: rgba(106,169,255,.65); color:var(--text); background: rgba(106,169,255,.10)}
    .hidden{display:none !important}
    .badge{display:inline-flex; padding:4px 8px; border-radius:999px; border:1px solid var(--border); font-size:12px; color:var(--muted)}
    .center{display:flex; align-items:center; justify-content:center}
    .big{font-size:34px; font-weight:900; letter-spacing:.3px}
    .toast{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      padding:10px 14px; border-radius:999px;
      border:1px solid var(--border); background: rgba(18,26,43,.92);
      color:var(--text); box-shadow: 0 10px 30px rgba(0,0,0,.35);
      opacity:0; pointer-events:none; transition: opacity .15s ease;
      max-width: calc(100vw - 28px);
      white-space: nowrap; overflow:hidden; text-overflow: ellipsis;
    }
    .toast.show{opacity:1}
    .good{color:var(--ok)}
    .bad{color:var(--bad)}
    .grid2{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    .rec{ padding:10px 12px; border-radius:14px; border:1px solid var(--border); background: rgba(255,255,255,.04); }
    .mem{ display:grid; grid-template-columns: repeat(4, 1fr); gap:8px; max-width:520px; }
    .cardtile{
      aspect-ratio: 1/1;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      display:flex; align-items:center; justify-content:center;
      font-size:28px; font-weight:900;
      user-select:none; cursor:pointer;
    }

    /* 2048 */
    .g2048{max-width:520px}
    .g2048grid{
      display:grid; grid-template-columns: repeat(4,1fr); gap:10px;
      padding:12px; border-radius:18px; border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      touch-action: none;
    }
    .t2048{
      aspect-ratio: 1/1;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.15);
      display:flex; align-items:center; justify-content:center;
      font-weight:900; font-size:22px;
      user-select:none;
    }

    /* Snake */
    canvas{max-width:520px; width:100%; height:auto; border-radius:18px; border:1px solid rgba(255,255,255,.12); background: rgba(0,0,0,.18);}
    .dpad{display:grid; grid-template-columns: 60px 60px 60px; gap:8px; justify-content:center; margin-top:10px}
    .dpad .btn{padding:10px 0}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand"><span class="dot"></span> GameMaster Mini Games</div>
      <div class="row">
        <span class="pill" id="whoPill">Solo ‚Ä¢ Offline</span>
        <a class="btn secondary" id="openBotTop" href="#" rel="noreferrer">–û—Ç–∫—Ä—ã—Ç—å –±–æ—Ç–∞</a>
      </div>
    </div>

    <div class="grid">
      <div class="card" id="viewHome">
        <h1>–ú–∏–Ω–∏-–∏–≥—Ä—ã (1 –∏–≥—Ä–æ–∫)</h1>
        <p class="muted">–ë–µ–∑ –≤—Ö–æ–¥–∞. –†–µ–∫–æ—Ä–¥—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ.</p>

        <div class="sep"></div>

        <h2>–†–µ–∫–æ—Ä–¥—ã</h2>
        <div class="grid2" id="recordsBox"></div>
        <div class="row" style="margin-top:10px">
          <button class="btn secondary" id="sendToBot">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–µ–∫–æ—Ä–¥—ã –≤ –±–æ—Ç–∞</button>
          <button class="btn secondary" id="backToBot">‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –≤ –±–æ—Ç–∞</button>
          <button class="btn secondary" id="shareBot">üì£ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è –±–æ—Ç–æ–º</button>
          <button class="btn danger" id="clearRecords">–°–±—Ä–æ—Å–∏—Ç—å —Ä–µ–∫–æ—Ä–¥—ã</button>
        </div>

        <div class="sep"></div>

        <h2>–û—Ç–∑—ã–≤—ã</h2>
        <p class="muted">–û—Å—Ç–∞–≤—å –æ—Ç–∑—ã–≤ –ø—Ä—è–º–æ —Ç—É—Ç. –ï—Å–ª–∏ —Å–∞–π—Ç –æ—Ç–∫—Ä—ã—Ç –≤–Ω—É—Ç—Ä–∏ Telegram ‚Äî –æ—Ç–∑—ã–≤ —É–π–¥—ë—Ç –≤ –±–æ—Ç–∞.</p>

        <div class="row" style="align-items:stretch; width:100%">
          <div style="flex:1; min-width:160px">
            <div class="small muted" style="margin-bottom:6px">–û—Ü–µ–Ω–∫–∞ (1‚Äì5)</div>
            <input id="revRating" type="number" min="1" max="5" value="5" />
          </div>
          <div style="flex:3; min-width:240px">
            <div class="small muted" style="margin-bottom:6px">–¢–µ–∫—Å—Ç –æ—Ç–∑—ã–≤–∞</div>
            <input id="revText" type="text" maxlength="200" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: —Ç–æ–ø —Å–∞–π—Ç, –¥–æ–±–∞–≤—å –µ—â—ë –∏–≥—Ä!" />
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <button class="btn" id="sendReview">‚úçÔ∏è –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</button>
          <button class="btn secondary" id="openReviewsInBot">‚≠ê –°–º–æ—Ç—Ä–µ—Ç—å –æ—Ç–∑—ã–≤—ã –≤ –±–æ—Ç–µ</button>
        </div>
        <div class="small muted" id="revInfo" style="margin-top:8px"></div>

        <div class="sep"></div>

        <h2>–í—ã–±–æ—Ä –∏–≥—Ä—ã</h2>
        <div class="chips" id="gameChips">
          <div class="chip active" data-id="reaction">‚ö° –†–µ–∞–∫—Ü–∏—è</div>
          <div class="chip" data-id="guess">üéØ –£–≥–∞–¥–∞–π —á–∏—Å–ª–æ</div>
          <div class="chip" data-id="math">üß† –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞</div>
          <div class="chip" data-id="clicker">üñ±Ô∏è –ö–ª–∏–∫–µ—Ä 10—Å</div>
          <div class="chip" data-id="memory">üß© –ü–∞–º—è—Ç—å 4√ó4</div>
          <div class="chip" data-id="rps">‚úä‚úã‚úå –ö–ù–ë</div>
          <div class="chip" data-id="g2048">üéÆ 2048</div>
          <div class="chip" data-id="snake">üêç Snake</div>
        </div>

        <div class="row" style="margin-top:12px">
          <button class="btn" id="startBtn">–ó–∞–ø—É—Å—Ç–∏—Ç—å</button>
          <button class="btn secondary" id="resetBtn">–°–±—Ä–æ—Å –≤—ã–±–æ—Ä–∞</button>
        </div>

        <div class="sep"></div>
        <div class="small muted">
          –ü–æ–¥—Å–∫–∞–∑–∫–∞: —á—Ç–æ–±—ã –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ –±–æ—Ç–∞ —Ä–∞–±–æ—Ç–∞–ª–∞ ‚Äî –æ—Ç–∫—Ä–æ–π —Å–∞–π—Ç –∏–∑ –∫–Ω–æ–ø–∫–∏ –±–æ—Ç–∞ (Telegram WebApp).
        </div>
      </div>

      <div class="card hidden" id="viewGame">
        <div class="row" style="justify-content:space-between">
          <div class="row" style="gap:8px; flex-wrap:wrap">
            <span class="badge" id="badgeGame">–ò–≥—Ä–∞</span>
          </div>
          <div class="row">
            <button class="btn secondary" id="backBtn">‚Üê –ù–∞–∑–∞–¥</button>
          </div>
        </div>
        <div class="sep"></div>
        <div id="gameRoot"></div>
      </div>

      <div class="card2">
        <h2>–ü–æ–¥—Å–∫–∞–∑–∫–∞</h2>
        <div class="small muted">
          –ü—Ä—è–º—ã–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ –∏–≥—Ä—É: <b>#snake</b> –∏ <b>#g2048</b> (–Ω–∞–ø—Ä–∏–º–µ—Ä: /#snake).
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
/* ===== Consts ===== */
const BOT_USERNAME = "Gamemasterbot_2bot";
const BOT_LINK = "https://t.me/" + BOT_USERNAME;

/* ===== Helpers ===== */
const $ = (s, el=document) => el.querySelector(s);
const $$ = (s, el=document) => Array.from(el.querySelectorAll(s));

const toastEl = $("#toast");
let toastTimer = null;
function toast(msg){
  toastEl.textContent = msg;
  toastEl.classList.add("show");
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => toastEl.classList.remove("show"), 1500);
}

/* ===== Telegram helpers ===== */
function tgObj(){ return window.Telegram?.WebApp || null; }

function openBotLink(url){
  const tg = tgObj();
  if(tg?.openTelegramLink) tg.openTelegramLink(url);
  else window.open(url, "_blank");
}

function openBot(){
  openBotLink(BOT_LINK);
}

function shareBot(){
  const tgShareUrl = "https://t.me/share/url?url=" + encodeURIComponent(BOT_LINK) +
    "&text=" + encodeURIComponent("–ò–≥—Ä–∞–π –≤ –º–∏–Ω–∏-–∏–≥—Ä—ã üéÆ –≤ –±–æ—Ç–µ @" + BOT_USERNAME);
  const tg = tgObj();
  if(tg?.openTelegramLink) tg.openTelegramLink(tgShareUrl);
  else if(navigator.share) navigator.share({ title:"GameMaster", text:"–ò–≥—Ä–∞–π –≤ –º–∏–Ω–∏-–∏–≥—Ä—ã", url: BOT_LINK }).catch(()=>{});
  else window.open(tgShareUrl, "_blank");
}

$("#openBotTop").onclick = (e)=>{ e.preventDefault(); openBot(); };
$("#backToBot").onclick = ()=> openBot();
$("#shareBot").onclick = ()=> shareBot();
$("#openReviewsInBot").onclick = ()=> openBotLink(BOT_LINK + "?start=reviews");

/* ===== Telegram init (UI + ready) ===== */
(function(){
  const tg = tgObj();
  if(!tg) return;
  try{
    tg.ready(); // –≤–∞–∂–Ω–æ
    tg.expand();

    const u = tg.initDataUnsafe?.user;
    if(u){
      const name = u.username ? "@"+u.username : (u.first_name || "TG Player");
      $("#whoPill").textContent = `TG: ${name}`;
    } else {
      $("#whoPill").textContent = "Telegram WebApp";
    }

    const tp = tg.themeParams || {};
    const root = document.documentElement;
    if(tp.bg_color) root.style.setProperty("--bg", tp.bg_color);
    if(tp.text_color) root.style.setProperty("--text", tp.text_color);
    if(tp.hint_color) root.style.setProperty("--muted", tp.hint_color);
    if(tp.button_color) root.style.setProperty("--acc", tp.button_color);
  }catch(e){
    console.log("TG init error", e);
  }
})();

/* ===== Records (localStorage) ===== */
const REC_KEY = "gm_records_v2";
const defaultRec = {
  reaction_best_ms: null,
  guess_best_tries: null,
  math_best_score: null,
  clicker_best: null,
  memory_best_moves: null,
  g2048_best_score: null,
  g2048_best_tile: null,
  snake_best_score: null
};
function loadRec(){
  try{
    const x = JSON.parse(localStorage.getItem(REC_KEY) || "null");
    return {...defaultRec, ...(x||{})};
  }catch{ return {...defaultRec}; }
}
function saveRec(rec){ localStorage.setItem(REC_KEY, JSON.stringify(rec)); }
function renderRec(){
  const r = loadRec();
  const fmt = (v, suf="") => (v===null || v===undefined) ? "‚Äî" : (String(v)+suf);
  $("#recordsBox").innerHTML = `
    <div class="rec"><div class="small">‚ö° –†–µ–∞–∫—Ü–∏—è</div><div class="big">${fmt(r.reaction_best_ms," –º—Å")}</div></div>
    <div class="rec"><div class="small">üéØ –£–≥–∞–¥–∞–π</div><div class="big">${fmt(r.guess_best_tries," –ø–æ–ø—ã—Ç–æ–∫")}</div></div>
    <div class="rec"><div class="small">üß† –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞</div><div class="big">${fmt(r.math_best_score,"")}</div></div>
    <div class="rec"><div class="small">üñ±Ô∏è –ö–ª–∏–∫–µ—Ä</div><div class="big">${fmt(r.clicker_best,"")}</div></div>
    <div class="rec"><div class="small">üß© –ü–∞–º—è—Ç—å</div><div class="big">${fmt(r.memory_best_moves,"")}</div></div>
    <div class="rec"><div class="small">üéÆ 2048 (–æ—á–∫–∏)</div><div class="big">${fmt(r.g2048_best_score,"")}</div></div>
    <div class="rec"><div class="small">üéÆ 2048 (–ø–ª–∏—Ç–∫–∞)</div><div class="big">${fmt(r.g2048_best_tile,"")}</div></div>
    <div class="rec"><div class="small">üêç Snake</div><div class="big">${fmt(r.snake_best_score,"")}</div></div>
  `;
}
$("#clearRecords").onclick = () => {
  localStorage.removeItem(REC_KEY);
  renderRec();
  toast("–†–µ–∫–æ—Ä–¥—ã —Å–±—Ä–æ—à–µ–Ω—ã");
};

/* ===== Send records to bot ===== */
$("#sendToBot").onclick = () => {
  const tg = tgObj();
  if(!tg || !tg.initDataUnsafe){
    toast("‚ùå –û—Ç–∫—Ä–æ–π —Å–∞–π—Ç —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É –±–æ—Ç–∞");
    return;
  }
  const payload = { type:"records", records: loadRec(), ts: Date.now() };
  try{
    tg.ready?.();
    tg.sendData(JSON.stringify(payload));
    toast("‚úÖ –†–µ–∫–æ—Ä–¥—ã –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã");
  }catch(e){
    console.log("sendData records error", e);
    toast("‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏");
  }
};

/* ===== Reviews (site -> bot) ===== */
$("#sendReview").onclick = () => {
  const rating = Number($("#revRating").value);
  const text = ($("#revText").value || "").trim();

  if(!Number.isFinite(rating) || rating < 1 || rating > 5){
    toast("–û—Ü–µ–Ω–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å 1..5");
    return;
  }
  if(text.length < 3){
    toast("–û—Ç–∑—ã–≤ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π");
    return;
  }

  const tg = tgObj();

  // –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ –±–æ—Ç–∞ (—Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–æ –∫–∞–∫ Telegram WebApp)
  if(tg && tg.initDataUnsafe){
    try{
      tg.ready?.();
      tg.sendData(JSON.stringify({ type:"review", rating, text, ts: Date.now() }));
      $("#revText").value = "";
      $("#revInfo").textContent = "‚úÖ –û—Ç–∑—ã–≤ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ –±–æ—Ç–∞!";
      toast("–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ‚úÖ");
      return;
    }catch(e){
      console.log("sendData review error", e);
    }
  }

  // –µ—Å–ª–∏ –Ω–µ Telegram ‚Äî —Å–æ—Ö—Ä–∞–Ω–∏–º –ª–æ–∫–∞–ª—å–Ω–æ
  const key = "gm_local_reviews";
  const arr = JSON.parse(localStorage.getItem(key) || "[]");
  arr.push({ ts: Date.now(), rating, text });
  localStorage.setItem(key, JSON.stringify(arr.slice(-50)));

  $("#revText").value = "";
  $("#revInfo").textContent = "‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ (–æ—Ç–∫—Ä–æ–π –≤ Telegram, —á—Ç–æ–±—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ –±–æ—Ç–∞).";
  toast("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ");
};

/* ===== Navigation ===== */
const state = { gameId: "reaction" };

function showHome(){
  $("#viewHome").classList.remove("hidden");
  $("#viewGame").classList.add("hidden");
  $("#gameRoot").innerHTML = "";
  window.onkeydown = null;
}
function showGame(){
  $("#viewHome").classList.add("hidden");
  $("#viewGame").classList.remove("hidden");
}
function setActiveChip(){
  $$("#gameChips .chip").forEach(ch => ch.classList.toggle("active", ch.dataset.id === state.gameId));
}
$$("#gameChips .chip").forEach(ch => ch.onclick = () => { state.gameId = ch.dataset.id; setActiveChip(); });

$("#resetBtn").onclick = () => { state.gameId="reaction"; setActiveChip(); toast("–°–±—Ä–æ—à–µ–Ω–æ"); };
$("#backBtn").onclick = () => { location.hash = ""; showHome(); };
$("#startBtn").onclick = () => { showGame(); mountGame(state.gameId); };

function mountGame(id){
  const root = $("#gameRoot");
  root.innerHTML = "";
  window.onkeydown = null;

  if(id === "reaction") return mountReaction(root);
  if(id === "guess") return mountGuess(root);
  if(id === "math") return mountMath(root);
  if(id === "clicker") return mountClicker(root);
  if(id === "memory") return mountMemory(root);
  if(id === "rps") return mountRPS(root);
  if(id === "g2048") return mount2048(root);
  if(id === "snake") return mountSnake(root);

  root.innerHTML = `<p class="muted">–ò–≥—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.</p>`;
}

/* ===== Game: Reaction ===== */
function mountReaction(root){
  $("#badgeGame").textContent = "‚ö° –†–µ–∞–∫—Ü–∏—è";
  let stage="idle", startAt=0, timer=null;

  root.innerHTML = `
    <h2>‚ö° –†–µ–∞–∫—Ü–∏—è</h2>
    <p class="muted">–ù–∞–∂–º–∏ —Å—Ç–∞—Ä—Ç ‚Üí –∂–¥–∏ –∑–µ–ª—ë–Ω—ã–π —Å–∏–≥–Ω–∞–ª ‚Üí –∫–ª–∏–∫–Ω–∏ –±—ã—Å—Ç—Ä–æ.</p>
    <div class="card2" style="margin-top:12px">
      <div class="row" style="justify-content:space-between">
        <button class="btn" id="rStart">–°—Ç–∞—Ä—Ç</button>
        <button class="btn secondary" id="rReset">–°–±—Ä–æ—Å</button>
      </div>
      <div style="margin-top:12px">
        <div id="rBox" class="center" style="height:180px;border-radius:18px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);font-size:18px;font-weight:900;user-select:none;cursor:pointer;">
          –ù–∞–∂–º–∏ ¬´–°—Ç–∞—Ä—Ç¬ª
        </div>
      </div>
      <div class="small" id="rResult" style="margin-top:10px"></div>
    </div>
  `;
  const box=$("#rBox"), result=$("#rResult");

  function setBox(text, mode){
    box.textContent=text;
    if(mode==="go"){ box.style.background="rgba(76,255,180,.12)"; box.style.borderColor="rgba(76,255,180,.35)"; }
    else if(mode==="bad"){ box.style.background="rgba(255,106,138,.12)"; box.style.borderColor="rgba(255,106,138,.35)"; }
    else { box.style.background="rgba(255,255,255,.04)"; box.style.borderColor="rgba(255,255,255,.12)"; }
  }
  function reset(){
    stage="idle"; clearTimeout(timer); timer=null; startAt=0;
    result.textContent=""; setBox("–ù–∞–∂–º–∏ ¬´–°—Ç–∞—Ä—Ç¬ª","wait");
  }
  function start(){
    reset(); stage="waiting"; setBox("–ñ–¥–∏‚Ä¶","wait");
    timer=setTimeout(()=>{ stage="go"; startAt=performance.now(); setBox("–ñ–ú–ò!","go"); }, 900 + Math.random()*2200);
  }
  $("#rStart").onclick=start;
  $("#rReset").onclick=reset;

  box.onclick=()=>{
    if(stage==="idle"){ toast("–ù–∞–∂–º–∏ ¬´–°—Ç–∞—Ä—Ç¬ª"); return; }
    if(stage==="waiting"){
      stage="done"; clearTimeout(timer); timer=null;
      setBox("–°–ª–∏—à–∫–æ–º —Ä–∞–Ω–æ üòÖ","bad");
      result.innerHTML=`<span class="bad">–†–∞–Ω–æ!</span> –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑.`;
      return;
    }
    if(stage==="go"){
      stage="done";
      const ms=Math.round(performance.now()-startAt);
      setBox(`–í—Ä–µ–º—è: ${ms} –º—Å`,"go");
      let rec=loadRec();
      if(rec.reaction_best_ms===null || ms < rec.reaction_best_ms){
        rec.reaction_best_ms = ms; saveRec(rec); renderRec();
        result.innerHTML = `<span class="good">${ms} –º—Å</span> ‚Äî –Ω–æ–≤—ã–π —Ä–µ–∫–æ—Ä–¥!`;
      } else {
        result.innerHTML = `<span class="good">${ms} –º—Å</span>`;
      }
      return;
    }
    if(stage==="done"){ start(); }
  };
  reset();
}

/* ===== Game: Guess ===== */
function mountGuess(root){
  $("#badgeGame").textContent = "üéØ –£–≥–∞–¥–∞–π —á–∏—Å–ª–æ";
  let secret=1, tries=0;

  root.innerHTML = `
    <h2>üéØ –£–≥–∞–¥–∞–π —á–∏—Å–ª–æ</h2>
    <p class="muted">–Ø –∑–∞–≥–∞–¥–∞–ª 1..100. –í–≤–æ–¥–∏ —á–∏—Å–ª–æ ‚Äî —Å–∫–∞–∂—É –±–æ–ª—å—à–µ/–º–µ–Ω—å—à–µ.</p>
    <div class="card2" style="margin-top:12px">
      <div class="row">
        <input id="gInp" type="number" min="1" max="100" placeholder="1..100" style="flex:1; min-width:140px" />
        <button class="btn" id="gTry">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
        <button class="btn secondary" id="gNew">–ù–æ–≤–∞—è</button>
      </div>
      <div class="sep"></div>
      <div class="big" id="gHint">ü§´</div>
      <div class="small" id="gInfo" style="margin-top:10px"></div>
    </div>
  `;
  const inp=$("#gInp"), hint=$("#gHint"), info=$("#gInfo");

  function newGame(){
    secret=Math.floor(1+Math.random()*100);
    tries=0; hint.textContent="ü§´"; info.textContent="";
    inp.value=""; inp.focus();
    toast("–ó–∞–≥–∞–¥–∞–ª –Ω–æ–≤–æ–µ —á–∏—Å–ª–æ");
  }
  function check(){
    const v=Number(inp.value);
    if(!Number.isFinite(v) || v<1 || v>100){ toast("–í–≤–µ–¥–∏ 1..100"); return; }
    tries++;
    if(v===secret){
      hint.innerHTML=`<span class="good">üéâ –£–≥–∞–¥–∞–ª!</span>`;
      let rec=loadRec();
      if(rec.guess_best_tries===null || tries < rec.guess_best_tries){
        rec.guess_best_tries=tries; saveRec(rec); renderRec();
        info.innerHTML=`–ü–æ–ø—ã—Ç–æ–∫: <b>${tries}</b> ‚Äî –Ω–æ–≤—ã–π —Ä–µ–∫–æ—Ä–¥!`;
      } else info.innerHTML=`–ü–æ–ø—ã—Ç–æ–∫: <b>${tries}</b>`;
      toast("–ü–æ–±–µ–¥–∞!");
      return;
    }
    hint.textContent = (v<secret) ? "–ë–æ–ª—å—à–µ ‚Üë" : "–ú–µ–Ω—å—à–µ ‚Üì";
    info.textContent = `–ü–æ–ø—ã—Ç–æ–∫: ${tries}`;
  }
  $("#gTry").onclick=check;
  $("#gNew").onclick=newGame;
  inp.addEventListener("keydown",(e)=>{ if(e.key==="Enter") check(); });
  newGame();
}

/* ===== Game: Math ===== */
function mountMath(root){
  $("#badgeGame").textContent = "üß† –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞";
  let a=0,b=0,op="+",ans=0, score=0, timeLeft=30, timer=null;

  root.innerHTML = `
    <h2>üß† –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞ –Ω–∞ —Å–∫–æ—Ä–æ—Å—Ç—å</h2>
    <p class="muted">30 —Å–µ–∫—É–Ω–¥. –í–µ—Ä–Ω–æ ‚Üí +1.</p>
    <div class="card2" style="margin-top:12px">
      <div class="row" style="justify-content:space-between">
        <div class="badge">–û—á–∫–∏: <span id="mScore">0</span></div>
        <div class="badge">–í—Ä–µ–º—è: <span id="mTime">30</span>s</div>
      </div>
      <div class="sep"></div>
      <div class="big" id="mQ">‚Äî</div>
      <div class="row" style="margin-top:10px">
        <input id="mInp" type="number" placeholder="–û—Ç–≤–µ—Ç" style="flex:1; min-width:140px" />
        <button class="btn" id="mOk">–û–∫</button>
        <button class="btn secondary" id="mStart">–°—Ç–∞—Ä—Ç</button>
        <button class="btn danger" id="mStop">–°—Ç–æ–ø</button>
      </div>
      <div class="small" id="mInfo" style="margin-top:10px"></div>
    </div>
  `;
  const qEl=$("#mQ"), sEl=$("#mScore"), tEl=$("#mTime"), inp=$("#mInp"), info=$("#mInfo");

  function gen(){
    a=Math.floor(2+Math.random()*20);
    b=Math.floor(2+Math.random()*20);
    op=Math.random()<0.5?"+":"-";
    if(op==="-" && b>a){ const t=a;a=b;b=t; }
    ans = (op==="+") ? (a+b) : (a-b);
    qEl.textContent = `${a} ${op} ${b} = ?`;
    inp.value=""; inp.focus();
  }
  function stop(){
    clearInterval(timer); timer=null;
    info.innerHTML = `–ò—Ç–æ–≥: <b>${score}</b> –æ—á–∫–æ–≤.`;
    let rec=loadRec();
    if(rec.math_best_score===null || score > rec.math_best_score){
      rec.math_best_score=score; saveRec(rec); renderRec();
      info.innerHTML += ` <span class="good">–ù–æ–≤—ã–π —Ä–µ–∫–æ—Ä–¥!</span>`;
    }
    toast("–°—Ç–æ–ø");
  }
  function tick(){ timeLeft--; tEl.textContent=timeLeft; if(timeLeft<=0) stop(); }
  function start(){
    score=0; timeLeft=30;
    sEl.textContent=score; tEl.textContent=timeLeft;
    info.textContent="";
    gen();
    clearInterval(timer);
    timer=setInterval(tick,1000);
    toast("–ü–æ–µ—Ö–∞–ª–∏!");
  }
  function submit(){
    if(!timer){ toast("–ù–∞–∂–º–∏ ¬´–°—Ç–∞—Ä—Ç¬ª"); return; }
    const v=Number(inp.value);
    if(!Number.isFinite(v)){ toast("–í–≤–µ–¥–∏ —á–∏—Å–ª–æ"); return; }
    if(v===ans){ score++; sEl.textContent=score; toast("–í–µ—Ä–Ω–æ!"); gen(); }
    else { toast("–ù–µ–≤–µ—Ä–Ω–æ"); info.textContent=`–ü—Ä–∞–≤–∏–ª—å–Ω–æ: ${ans}`; gen(); }
  }
  $("#mStart").onclick=start;
  $("#mStop").onclick=stop;
  $("#mOk").onclick=submit;
  inp.addEventListener("keydown",(e)=>{ if(e.key==="Enter") submit(); });
  gen();
}

/* ===== Game: Clicker 10s ===== */
function mountClicker(root){
  $("#badgeGame").textContent = "üñ±Ô∏è –ö–ª–∏–∫–µ—Ä 10—Å";
  let score=0, timeLeft=10, timer=null, running=false;

  root.innerHTML = `
    <h2>üñ±Ô∏è –ö–ª–∏–∫–µ—Ä 10 —Å–µ–∫—É–Ω–¥</h2>
    <p class="muted">–ù–∞–∂–∏–º–∞–π –Ω–∞ –∫–Ω–æ–ø–∫—É –∫–∞–∫ –º–æ–∂–Ω–æ –±—ã—Å—Ç—Ä–µ–µ 10 —Å–µ–∫—É–Ω–¥.</p>
    <div class="card2" style="margin-top:12px">
      <div class="row" style="justify-content:space-between">
        <div class="badge">–ö–ª–∏–∫–∏: <span id="cScore">0</span></div>
        <div class="badge">–í—Ä–µ–º—è: <span id="cTime">10</span>s</div>
      </div>
      <div class="sep"></div>
      <div class="row">
        <button class="btn" id="cTap" style="flex:1; min-width:200px; height:70px; font-size:18px; font-weight:900;">–¢–ê–ü!</button>
        <button class="btn secondary" id="cStart">–°—Ç–∞—Ä—Ç</button>
        <button class="btn danger" id="cStop">–°—Ç–æ–ø</button>
      </div>
      <div class="small" id="cInfo" style="margin-top:10px"></div>
    </div>
  `;
  const sEl=$("#cScore"), tEl=$("#cTime"), info=$("#cInfo"), tap=$("#cTap");

  function end(){
    running=false; clearInterval(timer); timer=null;
    info.innerHTML = `–ò—Ç–æ–≥: <b>${score}</b>`;
    let rec=loadRec();
    if(rec.clicker_best===null || score > rec.clicker_best){
      rec.clicker_best=score; saveRec(rec); renderRec();
      info.innerHTML += ` <span class="good">–ù–æ–≤—ã–π —Ä–µ–∫–æ—Ä–¥!</span>`;
    }
    toast("–ì–æ—Ç–æ–≤–æ!");
  }
  function tick(){ timeLeft--; tEl.textContent=timeLeft; if(timeLeft<=0) end(); }
  function start(){
    score=0; timeLeft=10; running=true;
    sEl.textContent=score; tEl.textContent=timeLeft; info.textContent="";
    clearInterval(timer); timer=setInterval(tick,1000);
    toast("–°—Ç–∞—Ä—Ç!");
  }
  tap.onclick=()=>{ if(!running){ toast("–ù–∞–∂–º–∏ ¬´–°—Ç–∞—Ä—Ç¬ª"); return; } score++; sEl.textContent=score; };
  $("#cStart").onclick=start;
  $("#cStop").onclick=end;
}

/* ===== Game: Memory 4x4 ===== */
function mountMemory(root){
  $("#badgeGame").textContent = "üß© –ü–∞–º—è—Ç—å 4√ó4";
  const icons = ["üçí","üçã","üçá","üçâ","üçì","ü•ù","üçë","üçç"];
  let deck = [...icons, ...icons].sort(()=>Math.random()-0.5);
  let open = [];
  let matched = new Set();
  let moves = 0;
  let lock = false;

  root.innerHTML = `
    <h2>üß© –ü–∞–º—è—Ç—å 4√ó4</h2>
    <p class="muted">–û—Ç–∫—Ä–æ–π 2 –∫–∞—Ä—Ç–æ—á–∫–∏. –ï—Å–ª–∏ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ ‚Äî –æ—Å—Ç–∞—é—Ç—Å—è –æ—Ç–∫—Ä—ã—Ç—ã–º–∏.</p>
    <div class="card2" style="margin-top:12px">
      <div class="row" style="justify-content:space-between">
        <div class="badge">–•–æ–¥—ã: <span id="mmMoves">0</span></div>
        <button class="btn secondary" id="mmNew">–ù–æ–≤–∞—è</button>
      </div>
      <div class="sep"></div>
      <div class="mem" id="mmGrid"></div>
      <div class="small" id="mmInfo" style="margin-top:10px"></div>
    </div>
  `;
  const grid=$("#mmGrid"), mEl=$("#mmMoves"), info=$("#mmInfo");

  function render(){
    mEl.textContent = moves;
    grid.innerHTML = "";
    for(let i=0;i<deck.length;i++){
      const isOpen = open.includes(i) || matched.has(i);
      const tile = document.createElement("div");
      tile.className = "cardtile";
      tile.textContent = isOpen ? deck[i] : "‚Ä¢";
      tile.onclick = () => flip(i);
      grid.appendChild(tile);
    }
  }
  function win(){
    info.innerHTML = `<span class="good">–ì–æ—Ç–æ–≤–æ!</span> –•–æ–¥–æ–≤: <b>${moves}</b>`;
    let rec=loadRec();
    if(rec.memory_best_moves===null || moves < rec.memory_best_moves){
      rec.memory_best_moves = moves; saveRec(rec); renderRec();
      info.innerHTML += ` ‚Äî <span class="good">–ù–æ–≤—ã–π —Ä–µ–∫–æ—Ä–¥!</span>`;
    }
    toast("–ü–æ–±–µ–¥–∞!");
  }
  function flip(i){
    if(lock) return;
    if(matched.has(i)) return;
    if(open.includes(i)) return;

    open.push(i);
    if(open.length === 2) moves++;
    render();

    if(open.length < 2) return;

    const [a,b] = open;
    if(deck[a] === deck[b]){
      matched.add(a); matched.add(b);
      open = [];
      render();
      if(matched.size === deck.length) win();
      return;
    }

    lock = true;
    setTimeout(()=>{
      open = [];
      lock = false;
      render();
    }, 550);
  }

  $("#mmNew").onclick = () => {
    deck = [...icons, ...icons].sort(()=>Math.random()-0.5);
    open=[]; matched=new Set(); moves=0; lock=false; info.textContent="";
    render();
    toast("–ù–æ–≤–∞—è –∏–≥—Ä–∞");
  };

  render();
}

/* ===== Game: RPS ===== */
function mountRPS(root){
  $("#badgeGame").textContent = "‚úä‚úã‚úå –ö–ù–ë";
  const choices = [
    { id:"rock", label:"‚úä –ö–∞–º–µ–Ω—å" },
    { id:"paper", label:"‚úã –ë—É–º–∞–≥–∞" },
    { id:"scissors", label:"‚úå –ù–æ–∂–Ω–∏—Ü—ã" }
  ];
  let wins=0, loses=0, draws=0;

  root.innerHTML = `
    <h2>‚úä‚úã‚úå –ö–∞–º–µ–Ω—å-–ù–æ–∂–Ω–∏—Ü—ã-–ë—É–º–∞–≥–∞</h2>
    <p class="muted">–í—ã–±–∏—Ä–∞–π —Ö–æ–¥. –ö–æ–º–ø—å—é—Ç–µ—Ä –≤—ã–±–∏—Ä–∞–µ—Ç —Å–ª—É—á–∞–π–Ω–æ.</p>
    <div class="card2" style="margin-top:12px">
      <div class="row" id="rpsBtns"></div>
      <div class="sep"></div>
      <div class="row" style="justify-content:space-between; align-items:center">
        <div class="badge">–ü–æ–±–µ–¥—ã: <span id="rpsW">0</span></div>
        <div class="badge">–ü–æ—Ä–∞–∂–µ–Ω–∏—è: <span id="rpsL">0</span></div>
        <div class="badge">–ù–∏—á—å–∏: <span id="rpsD">0</span></div>
      </div>
      <div class="sep"></div>
      <div class="big" id="rpsResult">–í—ã–±–µ—Ä–∏ —Ö–æ–¥</div>
      <div class="small muted" id="rpsSub" style="margin-top:10px">‚Äî</div>
      <div class="sep"></div>
      <div class="row"><button class="btn secondary" id="rpsReset">–°–±—Ä–æ—Å–∏—Ç—å —Å—á—ë—Ç</button></div>
    </div>
  `;

  const btns=$("#rpsBtns");
  const wEl=$("#rpsW"), lEl=$("#rpsL"), dEl=$("#rpsD");
  const resEl=$("#rpsResult"), subEl=$("#rpsSub");

  function cpuPick(){ return choices[Math.floor(Math.random()*choices.length)]; }
  function judge(p,c){
    if(p.id===c.id) return "draw";
    if((p.id==="rock"&&c.id==="scissors")||(p.id==="paper"&&c.id==="rock")||(p.id==="scissors"&&c.id==="paper")) return "win";
    return "lose";
  }
  function setScore(){ wEl.textContent=wins; lEl.textContent=loses; dEl.textContent=draws; }
  function play(player){
    const cpu=cpuPick();
    const r=judge(player,cpu);
    subEl.textContent = `–¢—ã: ${player.label} ‚Ä¢ –ö–æ–º–ø: ${cpu.label}`;
    if(r==="win"){ wins++; resEl.innerHTML=`<span class="good">–¢—ã –ø–æ–±–µ–¥–∏–ª ‚úÖ</span>`; toast("–ü–æ–±–µ–¥–∞!"); }
    else if(r==="lose"){ loses++; resEl.innerHTML=`<span class="bad">–¢—ã –ø—Ä–æ–∏–≥—Ä–∞–ª ‚ùå</span>`; toast("–ü—Ä–æ–∏–≥—Ä—ã—à"); }
    else { draws++; resEl.textContent="–ù–∏—á—å—è ü§ù"; toast("–ù–∏—á—å—è"); }
    setScore();
  }

  choices.forEach(c=>{
    const b=document.createElement("button");
    b.className="btn";
    b.textContent=c.label;
    b.onclick=()=>play(c);
    btns.appendChild(b);
  });

  $("#rpsReset").onclick=()=>{ wins=loses=draws=0; setScore(); resEl.textContent="–í—ã–±–µ—Ä–∏ —Ö–æ–¥"; subEl.textContent="‚Äî"; toast("–°–±—Ä–æ—à–µ–Ω–æ"); };
  setScore();
}

/* ===== Game: 2048 ===== */
function mount2048(root){
  $("#badgeGame").textContent = "üéÆ 2048";

  let board = Array.from({length:4}, ()=>Array(4).fill(0));
  let score = 0;

  root.innerHTML = `
    <h2>üéÆ 2048</h2>
    <p class="muted">–°–≤–∞–π–ø—ã –∏–ª–∏ —Å—Ç—Ä–µ–ª–∫–∏. –°–æ–µ–¥–∏–Ω—è–π –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ —á–∏—Å–ª–∞.</p>
    <div class="card2 g2048" style="margin-top:12px">
      <div class="row" style="justify-content:space-between; align-items:center">
        <div class="badge">–û—á–∫–∏: <span id="s2048">0</span></div>
        <div class="badge">–ú–∞–∫—Å –ø–ª–∏—Ç–∫–∞: <span id="t2048">0</span></div>
        <button class="btn secondary" id="n2048">–ù–æ–≤–∞—è</button>
      </div>
      <div class="sep"></div>
      <div class="g2048grid" id="grid2048"></div>
      <div class="small muted" id="info2048" style="margin-top:10px">‚Äî</div>
    </div>
  `;

  const grid = $("#grid2048");
  const sEl = $("#s2048");
  const tEl = $("#t2048");
  const info = $("#info2048");

  function emptyCells(){
    const res=[];
    for(let r=0;r<4;r++)for(let c=0;c<4;c++) if(board[r][c]===0) res.push([r,c]);
    return res;
  }
  function addRandom(){
    const empt = emptyCells();
    if(!empt.length) return false;
    const [r,c] = empt[Math.floor(Math.random()*empt.length)];
    board[r][c] = Math.random()<0.9 ? 2 : 4;
    return true;
  }
  function maxTile(){
    let m=0; for(let r=0;r<4;r++)for(let c=0;c<4;c++) m=Math.max(m, board[r][c]);
    return m;
  }
  function render(){
    grid.innerHTML = "";
    for(let r=0;r<4;r++){
      for(let c=0;c<4;c++){
        const v = board[r][c];
        const d = document.createElement("div");
        d.className = "t2048";
        d.textContent = v ? v : "";
        const alpha = v ? Math.min(0.35, 0.06 + Math.log2(v)*0.03) : 0.05;
        d.style.background = `rgba(106,169,255,${alpha})`;
        grid.appendChild(d);
      }
    }
    sEl.textContent = score;
    tEl.textContent = maxTile();
  }

  function slideLine(line){
    const arr = line.filter(x=>x!==0);
    let gained = 0;
    for(let i=0;i<arr.length-1;i++){
      if(arr[i]===arr[i+1]){
        arr[i]*=2;
        gained += arr[i];
        arr.splice(i+1,1);
      }
    }
    while(arr.length<4) arr.push(0);
    return {line: arr, gained};
  }

  function move(dir){
    const before = JSON.stringify(board);
    let gainedTotal = 0;

    if(dir==="L"||dir==="R"){
      for(let r=0;r<4;r++){
        let line = board[r].slice();
        if(dir==="R") line.reverse();
        const out = slideLine(line);
        let newLine = out.line;
        if(dir==="R") newLine = newLine.reverse();
        board[r] = newLine;
        gainedTotal += out.gained;
      }
    } else {
      for(let c=0;c<4;c++){
        let line = [board[0][c],board[1][c],board[2][c],board[3][c]];
        if(dir==="D") line.reverse();
        const out = slideLine(line);
        let newLine = out.line;
        if(dir==="D") newLine = newLine.reverse();
        for(let r=0;r<4;r++) board[r][c] = newLine[r];
        gainedTotal += out.gained;
      }
    }

    const changed = (JSON.stringify(board) !== before);
    if(!changed) return false;

    score += gainedTotal;
    addRandom();
    render();

    const rec = loadRec();
    const mt = maxTile();
    let updated = false;
    if(rec.g2048_best_score===null || score > rec.g2048_best_score){ rec.g2048_best_score = score; updated=true; }
    if(rec.g2048_best_tile===null || mt > rec.g2048_best_tile){ rec.g2048_best_tile = mt; updated=true; }
    if(updated){ saveRec(rec); renderRec(); }

    if(isGameOver()){
      info.innerHTML = `<span class="bad">–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞.</span> –ù–∞–∂–º–∏ ‚Äú–ù–æ–≤–∞—è‚Äù.`;
      toast("2048: Game Over");
    } else info.textContent = "‚Äî";

    return true;
  }

  function canMove(){
    if(emptyCells().length) return true;
    for(let r=0;r<4;r++){
      for(let c=0;c<4;c++){
        const v=board[r][c];
        if(r<3 && board[r+1][c]===v) return true;
        if(c<3 && board[r][c+1]===v) return true;
      }
    }
    return false;
  }
  function isGameOver(){ return !canMove(); }

  function newGame(){
    board = Array.from({length:4}, ()=>Array(4).fill(0));
    score = 0;
    addRandom(); addRandom();
    render();
    info.textContent = "–°–≤–∞–π–ø–∞–π –∏–ª–∏ –∂–º–∏ —Å—Ç—Ä–µ–ª–∫–∏";
    toast("2048: –ù–æ–≤–∞—è –∏–≥—Ä–∞");
  }

  window.onkeydown = (e)=>{
    const k=e.key;
    if(k==="ArrowLeft") { e.preventDefault(); move("L"); }
    else if(k==="ArrowRight") { e.preventDefault(); move("R"); }
    else if(k==="ArrowUp") { e.preventDefault(); move("U"); }
    else if(k==="ArrowDown") { e.preventDefault(); move("D"); }
  };

  let sx=0, sy=0;
  grid.addEventListener("touchstart",(e)=>{
    const t=e.changedTouches[0];
    sx=t.clientX; sy=t.clientY;
  }, {passive:true});
  grid.addEventListener("touchend",(e)=>{
    const t=e.changedTouches[0];
    const dx=t.clientX-sx, dy=t.clientY-sy;
    const ax=Math.abs(dx), ay=Math.abs(dy);
    if(Math.max(ax,ay) < 25) return;
    if(ax>ay) move(dx>0 ? "R":"L");
    else move(dy>0 ? "D":"U");
  }, {passive:true});

  $("#n2048").onclick = newGame;
  newGame();
}

/* ===== Game: Snake ===== */
function mountSnake(root){
  $("#badgeGame").textContent = "üêç Snake";

  const size = 20;
  const cell = 20;
  const speedMs = 120;

  let snake, dir, nextDir, food, score, timer, alive;

  root.innerHTML = `
    <h2>üêç Snake</h2>
    <p class="muted">–°—Ç—Ä–µ–ª–∫–∏ –Ω–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–µ –∏–ª–∏ –∫–Ω–æ–ø–∫–∏ –Ω–∏–∂–µ. –ï—à—å –µ–¥—É ‚Äî —Ä–∞—Å—Ç—ë—à—å.</p>
    <div class="card2" style="margin-top:12px">
      <div class="row" style="justify-content:space-between; align-items:center">
        <div class="badge">–°—á—ë—Ç: <span id="snScore">0</span></div>
        <div class="badge">–†–µ–∫–æ—Ä–¥: <span id="snBest">‚Äî</span></div>
        <button class="btn secondary" id="snNew">–ù–æ–≤–∞—è</button>
        <button class="btn danger" id="snStop">–°—Ç–æ–ø</button>
      </div>
      <div class="sep"></div>
      <canvas id="snCanvas" width="${size*cell}" height="${size*cell}"></canvas>

      <div class="dpad">
        <span></span>
        <button class="btn secondary" id="snUp">‚Üë</button>
        <span></span>
        <button class="btn secondary" id="snLeft">‚Üê</button>
        <button class="btn secondary" id="snDown">‚Üì</button>
        <button class="btn secondary" id="snRight">‚Üí</button>
      </div>

      <div class="small muted" id="snInfo" style="margin-top:10px">‚Äî</div>
    </div>
  `;

  const cvs = $("#snCanvas");
  const ctx = cvs.getContext("2d");
  const sEl = $("#snScore");
  const bestEl = $("#snBest");
  const info = $("#snInfo");

  function randCell(){ return {x: Math.floor(Math.random()*size), y: Math.floor(Math.random()*size)}; }
  function eq(a,b){ return a.x===b.x && a.y===b.y; }

  function placeFood(){
    while(true){
      const f = randCell();
      if(!snake.some(p=>eq(p,f))) { food=f; return; }
    }
  }

  function setBest(){
    const rec = loadRec();
    bestEl.textContent = (rec.snake_best_score==null) ? "‚Äî" : rec.snake_best_score;
  }

  function reset(){
    alive=true;
    snake = [{x:10,y:10},{x:9,y:10},{x:8,y:10}];
    dir = {x:1,y:0};
    nextDir = dir;
    score = 0;
    sEl.textContent = score;
    info.textContent = "–ò–≥—Ä–∞–π!";
    placeFood();
    setBest();
    draw();
    startLoop();
  }

  function stop(){
    alive=false;
    clearInterval(timer); timer=null;
    info.innerHTML = `<span class="bad">–°—Ç–æ–ø.</span> –ù–∞–∂–º–∏ ‚Äú–ù–æ–≤–∞—è‚Äù.`;
  }

  function startLoop(){
    clearInterval(timer);
    timer = setInterval(tick, speedMs);
  }

  function changeDir(d){
    if(d.x===-dir.x && d.y===-dir.y) return;
    nextDir = d;
  }

  function tick(){
    if(!alive) return;
    dir = nextDir;

    const head = snake[0];
    const nh = {x: head.x + dir.x, y: head.y + dir.y};

    if(nh.x<0||nh.y<0||nh.x>=size||nh.y>=size) return gameOver();
    if(snake.some(p=>eq(p,nh))) return gameOver();

    snake.unshift(nh);

    if(eq(nh,food)){
      score++;
      sEl.textContent = score;
      placeFood();
    } else {
      snake.pop();
    }

    draw();
  }

  function gameOver(){
    alive=false;
    clearInterval(timer); timer=null;

    const rec = loadRec();
    if(rec.snake_best_score==null || score > rec.snake_best_score){
      rec.snake_best_score = score;
      saveRec(rec); renderRec();
      info.innerHTML = `<span class="bad">Game Over.</span> <span class="good">–ù–æ–≤—ã–π —Ä–µ–∫–æ—Ä–¥!</span>`;
      toast("Snake: —Ä–µ–∫–æ—Ä–¥!");
    } else {
      info.innerHTML = `<span class="bad">Game Over.</span> –ù–∞–∂–º–∏ ‚Äú–ù–æ–≤–∞—è‚Äù.`;
      toast("Snake: Game Over");
    }
    setBest();
  }

  function draw(){
    ctx.clearRect(0,0,cvs.width,cvs.height);

    ctx.globalAlpha = 0.12;
    for(let i=0;i<=size;i++){
      ctx.beginPath(); ctx.moveTo(i*cell,0); ctx.lineTo(i*cell,size*cell); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(0,i*cell); ctx.lineTo(size*cell,i*cell); ctx.stroke();
    }
    ctx.globalAlpha = 1;

    ctx.fillRect(food.x*cell+4, food.y*cell+4, cell-8, cell-8);

    snake.forEach((p,idx)=>{
      const pad = idx===0 ? 2 : 5;
      ctx.fillRect(p.x*cell+pad, p.y*cell+pad, cell-pad*2, cell-pad*2);
    });
  }

  window.onkeydown = (e)=>{
    const k=e.key;
    if(k==="ArrowUp") { e.preventDefault(); changeDir({x:0,y:-1}); }
    else if(k==="ArrowDown") { e.preventDefault(); changeDir({x:0,y:1}); }
    else if(k==="ArrowLeft") { e.preventDefault(); changeDir({x:-1,y:0}); }
    else if(k==="ArrowRight") { e.preventDefault(); changeDir({x:1,y:0}); }
  };

  $("#snUp").onclick=()=>changeDir({x:0,y:-1});
  $("#snDown").onclick=()=>changeDir({x:0,y:1});
  $("#snLeft").onclick=()=>changeDir({x:-1,y:0});
  $("#snRight").onclick=()=>changeDir({x:1,y:0});
  $("#snNew").onclick=reset;
  $("#snStop").onclick=stop;

  let sx=0, sy=0;
  cvs.addEventListener("touchstart",(e)=>{
    const t=e.changedTouches[0];
    sx=t.clientX; sy=t.clientY;
  }, {passive:true});
  cvs.addEventListener("touchend",(e)=>{
    const t=e.changedTouches[0];
    const dx=t.clientX-sx, dy=t.clientY-sy;
    const ax=Math.abs(dx), ay=Math.abs(dy);
    if(Math.max(ax,ay)<25) return;
    if(ax>ay) changeDir(dx>0 ? {x:1,y:0}:{x:-1,y:0});
    else changeDir(dy>0 ? {x:0,y:1}:{x:0,y:-1});
  }, {passive:true});

  reset();
}

/* init */
renderRec();
showHome();
setActiveChip();

/* –ê–≤—Ç–æ-–æ—Ç–∫—Ä—ã—Ç–∏–µ –∏–≥—Ä—ã –ø–æ —Å—Å—ã–ª–∫–µ: .../#snake, .../#g2048 –∏ —Ç.–¥. */
(function(){
  const h = (location.hash || "").replace("#","");
  if(!h) return;
  const allowed = new Set(["reaction","guess","math","clicker","memory","rps","g2048","snake"]);
  if(!allowed.has(h)) return;

  state.gameId = h;
  setActiveChip();
  showGame();
  mountGame(state.gameId);
})();
</script>
</body>
  </html>
